<html>
	<head>
		<link
			href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap"
			rel="stylesheet"
		/>
		<style>
			body {
				margin: 0;
				background: #000;
				overflow: hidden;
				font-family: "Roboto", sans-serif;
			}

			*:focus {
				outline: none;
			}

			#stream {
				position: fixed;
				margin: auto;
				left: 0;
				top: 0;
				right: 0;
				height: calc(100vh - 48px);
				width: calc((100vh - 48px) * (16 / 9));
			}

			.info-bar {
				position: fixed;
				margin: auto;
				left: 0;
				bottom: 0;
				right: 0;
				background: #1d1f21;
				height: 48px;
				color: #fff;
				font-size: 1.2rem;
				display: flex;
				align-items: center;
				padding: 0 16px;
			}

			.info-bar * {
				margin: 0;
			}

			.info-bar button {
				font-size: 1.2rem;
				font-family: "Roboto", sans-serif;
				border: none;
				background: rgba(255, 255, 255, 0.2);
				color: #fff;
				border-radius: 4px;
				padding: 4px 12px;
			}

			.info-bar button:disabled {
				opacity: 0.4;
			}

			#volume-slider {
				width: 200px;
			}

			@keyframes mat-progress-spinner-stroke-rotate-100 {
				0% {
					stroke-dashoffset: 268.606171575px;
					transform: rotate(0);
				}
				12.5% {
					stroke-dashoffset: 56.5486677px;
					transform: rotate(0);
				}
				12.5001% {
					stroke-dashoffset: 56.5486677px;
					transform: rotateX(180deg) rotate(72.5deg);
				}
				25% {
					stroke-dashoffset: 268.606171575px;
					transform: rotateX(180deg) rotate(72.5deg);
				}
				25.0001% {
					stroke-dashoffset: 268.606171575px;
					transform: rotate(270deg);
				}
				37.5% {
					stroke-dashoffset: 56.5486677px;
					transform: rotate(270deg);
				}
				37.5001% {
					stroke-dashoffset: 56.5486677px;
					transform: rotateX(180deg) rotate(161.5deg);
				}
				50% {
					stroke-dashoffset: 268.606171575px;
					transform: rotateX(180deg) rotate(161.5deg);
				}
				50.0001% {
					stroke-dashoffset: 268.606171575px;
					transform: rotate(180deg);
				}
				62.5% {
					stroke-dashoffset: 56.5486677px;
					transform: rotate(180deg);
				}
				62.5001% {
					stroke-dashoffset: 56.5486677px;
					transform: rotateX(180deg) rotate(251.5deg);
				}
				75% {
					stroke-dashoffset: 268.606171575px;
					transform: rotateX(180deg) rotate(251.5deg);
				}
				75.001% {
					stroke-dashoffset: 268.606171575px;
					transform: rotate(90deg);
				}
				87.5% {
					stroke-dashoffset: 56.5486677px;
					transform: rotate(90deg);
				}
				87.5001% {
					stroke-dashoffset: 56.5486677px;
					transform: rotateX(180deg) rotate(341.5deg);
				}
				100% {
					stroke-dashoffset: 268.606171575px;
					transform: rotateX(180deg) rotate(341.5deg);
				}
			}

			@keyframes mat-progress-spinner-linear-rotate {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			.progress-spinner {
				width: 100px;
				height: 100px;
				animation: mat-progress-spinner-linear-rotate 2000ms linear
					infinite;
			}

			.progress-spinner circle {
				stroke-dasharray: 282.743px;
				stroke-width: 10%;
				stroke: #fff;
				opacity: 0.25;
				animation-name: mat-progress-spinner-stroke-rotate-100;
				animation-duration: 4000ms;
				animation-timing-function: cubic-bezier(0.35, 0, 0.25, 1);
				animation-iteration-count: infinite;
				fill: transparent;
				transform-origin: center;
				transition: stroke-dashoffset 225ms linear;
				transition-property: stroke;
			}

			.progress-spinner-container {
				position: fixed;
				margin: auto;
				top: 0;
				left: 0;
				bottom: 0;
				right: 0;
				width: 100px;
				height: 100px;
			}
		</style>
	</head>
	<body>
		<video id="stream" tabindex="-1" autoplay></video>
		<div class="info-bar">
			<button id="toggle-controls" disabled></button>
			<div style="margin-left: 16px" style="opacity: 0.4">
				<p>Local volume</p>
				<input
					type="range"
					min="0"
					max="1"
					step="0.01"
					value="0"
					id="volume-slider"
				/>
			</div>
			<p id="users" style="opacity: 0.4; margin-left: 16px"></p>
		</div>
		<div class="progress-spinner-container" id="loading">
			<svg
				class="progress-spinner"
				focusable="false"
				viewBox="0 0 100 100"
			>
				<circle cx="50%" cy="50%" r="45" style=""></circle>
			</svg>
		</div>
		<script src="lib/adapter.min.js"></script>
		<script src="lib/socket.io.js"></script>
		<script src="lib/janus.js"></script>
		<script src="lib/Keyboard.js"></script>
		<script src="index.js"></script>
		<script>
			var _GET = {};
			window.location.search
				.substr(1)
				.split("&")
				.forEach(function (e, i) {
					if (e == "") return;
					let param = e.split("=");
					let value = param[1];
					if (value == undefined) value = null;
					_GET[param[0]] = value;
				});

			// dynamic lights

			if (_GET.dynamicLights) {
				const video = document.querySelector("video");

				const canvas = document.createElement("canvas");
				canvas.width = canvas.height = 30;

				//document.body.appendChild(canvas);
				//let debug = document.createElement("h2");
				//document.body.appendChild(debug);

				const ctx = canvas.getContext("2d");

				function getAverageColor(x, y) {
					let average = [0, 0, 0];
					let colors = ctx.getImageData(x * 10, y * 10, 10, 10).data;

					for (let i = 0; i < 100; i++) {
						let index = i * 4;
						average[0] += colors[index];
						average[1] += colors[index + 1];
						average[2] += colors[index + 2];
					}

					return [
						Math.floor(average[0] / 100),
						Math.floor(average[1] / 100),
						Math.floor(average[2] / 100),
					];
				}

				function getColors() {
					let colors = new Array();
					[
						// top
						getAverageColor(0, 0),
						getAverageColor(1, 0),
						getAverageColor(2, 0),
						// middle
						getAverageColor(0, 1),
						getAverageColor(2, 1),
						// bottom
						getAverageColor(0, 2),
						getAverageColor(1, 2),
						getAverageColor(2, 2),
					].forEach(c => {
						colors = colors.concat([c[0], c[1], c[2]]);
					});

					return colors.join(",");
				}

				let renderWidth = canvas.width;
				if (_GET["3D"]) renderWidth = canvas.width * 2;

				setInterval(() => {
					ctx.drawImage(stream, 0, 0, renderWidth, canvas.height);

					let color = getColors();
					//debug.textContent = getColors();

					if (window.qt) EventBridge.emitWebEvent(color);
				}, 1000 / 30);
			}
		</script>
	</body>
</html>
